{% extends "chama/loginBase.html" %}
{% load static %}

{% block content %}
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
      <a href="{% url 'manager:dashboard' %}" class="logo d-flex align-items-center">
        <img src="{% static 'chama/img/favicon.png' %}" alt="">
        <span class="d-none d-lg-block">Dashboard</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->

    <div class="search-bar">
      <!-- <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Search" title="Enter search keyword">
        <button type="submit" title="Search"><i class="bi bi-search"></i></button>
      </form> -->
    </div>
    <!-- End Search Bar -->

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
          <a class="nav-link nav-icon search-bar-toggle " href="#">
            <i class="bi bi-search"></i>
          </a>
        </li><!-- End Search Icon-->

        <li class="nav-item dropdown pe-3">

          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <!-- <img src="{{ chama.manager_profile_picture }}" alt="Profile" class="rounded-circle img-fluid"> -->
            <i class="bi bi-person-circle">manager</i>
            <span class="d-none d-md-block dropdown-toggle ps-2"></span>
          </a><!-- End Profile Iamge Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <hr class="dropdown-divider">
            </li>

            <!-- <li>
              <a class="dropdown-item d-flex align-items-center" href="#">
                <i class="bi bi-question-circle"></i>
                <span>Need Help?</span>
              </a>
            </li> -->
            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <a class="dropdown-item d-flex align-items-center" href="{% url 'chama:signout' %}">
                <i class="bi bi-box-arrow-right"></i>
                <span>Sign Out</span>
              </a>
            </li>

          </ul><!-- End Profile Dropdown Items -->
        </li><!-- End Profile Nav -->

      </ul>
    </nav><!-- End Icons Navigation -->

  </header><!-- End Header -->

  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

      <li class="nav-heading">Pages</li>

      <!-- <li class="nav-item">
        <a class="nav-link collapsed" href="">
          <i class="ri-close-circle-line"></i>
          <span>Missed Rotation Contributions</span>
        </a>
      </li> -->

    </ul>

  </aside><!-- End Sidebar-->

  <main id="main" class="main">
    <div class="pagetitle d-flex justify-content-between align-items-center">
      <h1>{{ activity_name }}</h1>

        <div class="search-bar">
          {% if messages %}
          <div class="alert alert-success alert-dismissible fade show" role="alert" id="chama_created">
            {% for messages in messages %}
              <strong>{{ messages }}</strong>
            {% endfor %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}
        </div>
      
      <div class="ml-auto">
        <!-- <form method="POST" action="{% url 'manager:disburse_funds' activity_id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-success btn-sm" id="disburseBtn">
            Disburse Funds
          </button>
        </form> -->

      </div>



    </div><!-- End Page Title -->

    <section class="section dashboard">
      <div class="row">

        <!-- Left side columns -->
        <div class="col-lg-12">
          <div class="row">

            <!-- increase number shares card -->
            <div class="col-xxl-4 col-md-4">
              <div class="card info-card sales-card clickable-card" id="increaseSharesCard" >

                <div class="card-body">
                  <h5 class="card-title">Increase Shares<span>| members</span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="ri-arrow-up-double-fill"></i>
                    </div>
                    <div class="ps-3">
                      <span class="text-muted small pt-2 ps-1">Allow members to increase their shares.</span>
                    </div>
                  </div>
                </div>

              </div>

            </div><!-- End of increase number shares card -->

            <!-- Allow new member card -->
            <div class="col-xxl-4 col-md-4" >
              <div class="card info-card revenue-card clickable-card" id="allowNewMembersCard">

                <div class="card-body">
                  <h5 class="card-title">New Members<span>| past deadline</span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="ri-add-line"></i>
                    </div>
                    <div class="ps-3">
                      <span class="text-success pt-2 fw-bold">                     
                      </span> <span class="text-muted small pt-2 ps-1">
                        Allow new members to join the activity past the deadline.
                      </span>
    
                    </div>
                  </div>
                </div>

              </div>
            </div><!-- End of Allow new member card -->

            <!-- swap order numbers card -->
            <div class="col-xxl-4 col-md-4 clickable-card" id="swapOrder">
              <div class="card info-card revenue-card">

                <div class="card-body">
                  <h5 class="card-title">Swap Order<span>| members </span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="ri-swap-fill"></i>
                    </div>
                    <div class="ps-3">
                      <span class="text-success pt-2 fw-bold">
                      </span> <span class="text-muted small pt-2 ps-1">
                        Swap the order of members in the activity.
                      </span>

                    </div>
                  </div>
                </div>

              </div>
            </div><!-- End swap order numbers Card -->

            <!-- decrease number shares card -->
            <div class="col-xxl-4 col-md-4 clickable-card" id="reduceSharesCard">
              <div class="card info-card revenue-card">

                <div class="card-body">
                  <h5 class="card-title">Reduce Shares <span>|<button class="btn btn-danger btn-sm" type="button">coming soon</button> </span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="ri-arrow-down-double-line"></i>
                    </div>
                    <div class="ps-3">
                      <span class="text-success pt-2 fw-bold">
                      </span> <span class="text-muted small pt-2 ps-1">
                        Allow members to reduce their shares.
                      </span>

                    </div>
                  </div>
                </div>

              </div>

            </div><!-- End of decrease number shares card -->

            <!-- remove an activity member -->
            <div class="col-xxl-4 col-md-4">
              <div class="card info-card sales-card clickable-card" id="removeMemberCard" >

                <div class="card-body">
                  <h5 class="card-title">Remove Member <span>| admin</span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="ri-pass-expired-fill"></i>
                    </div>
                    <div class="ps-3">
                      <span class="text-muted small pt-2 ps-1">Remove a member from the activity.</span>
                    </div>
                  </div>
                </div>

              </div>

            </div>
             <!-- end of removing an activity member -->

            {% if category == 'public' %}
             <!-- admin fee -->
             <div class="col-xxl-4 col-md-4">
              <div class="card info-card sales-card clickable-card" id="adminFeesCard" >

                <div class="card-body">
                  <h5 class="card-title">Admin Fee <span>| public</span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="ri-admin-fill"></i>
                    </div>
                    <div class="ps-3">
                      <span class="text-muted small pt-2 ps-1">Will this activity have an admin fee?</span>
                    </div>
                  </div>
                </div>

              </div>

            </div>

             <!-- end of admin fee -->

             <!-- co managers -->
             <div class="col-xxl-4 col-md-4">
              <div class="card info-card sales-card clickable-card" id="coManagersCard" >

                <div class="card-body">
                  <h5 class="card-title">Co-Managers <span>| public chamas</span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="ri-admin-line"></i>
                    </div>
                    <div class="ps-3">
                      <span class="text-muted small pt-2 ps-1">Allow others to manage the activity.</span>
                    </div>
                  </div>
                </div>

              </div>

            </div>

              <!-- end of co managers -->
            {% endif %}

              <!-- exit rules -->
              <div class="col-xxl-4 col-md-4">
                <div class="card info-card sales-card clickable-card" id="exitRulesCard" >
  
                  <div class="card-body">
                    <h5 class="card-title">Exit Rules <span>| before end of cycle</span></h5>
  
                    <div class="d-flex align-items-center">
                      <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                        <i class="ri-stop-fill"></i>
                      </div>
                      <div class="ps-3">
                        <span class="text-muted small pt-2 ps-1">Set rules for members who exit the activity before the end of the cycle.</span>
                      </div>
                    </div>
                  </div>
  
                </div>
  
              </div>

              <!-- end of exit rules -->

             <!-- increase shares form -->
             <div class="card shadow-lg border-0" id="increaseSharesForm" style="display: none; background-color: #f9fafc;">
              <div class="card-body p-4">
                <div class="card-title text-success">
                  <h5 class="teko-text">Allow Existing Members to Increase Their Shares</h5>
                  <hr>
                </div>
                <div class="pagetitle d-flex justify-content-between align-items-center mb-4">
                  <p class="arima-text text-secondary">
                    You can set the maximum number of shares that members can have, the deadline for adding shares and a fee for late share adjustments if any.
                    Members increasing shares will need to cover any past contributions for the new shares before the adjustment is made.
                  </p>
                </div>
            
                <form class="p-3" action="{% url 'manager:merry_go_round_share_increase' activity_id %}" method="POST">
                  {% csrf_token %}
                  <!-- Maximum shares input -->
                  <div class="mb-3">
                    <label for="max_addon" class="form-label fw-bold arima-text text-secondary">Maximum Number of Shares Users Can Have</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light text-secondary fw-bold">Shares:</span>
                      <input type="number" class="form-control border-0 shadow-sm" id="max_addon" name="max_addon" min="1" required>
                      <small class="amount-error-message text-danger"></small>
                    </div>
                  </div>
            
                  <!-- Deadline input -->
                  <div class="mb-3" id="deadline">
                    <label for="deadline" class="form-label fw-bold arima-text text-secondary">Final Date to Add Shares</label>
                    <div class="input-group">
                      <input type="date" class="form-control border-0 shadow-sm" id="deadline" name="deadline" required>
                    </div>
                    <small class="notify-manager text-danger">This date must be earlier than the next rotation date.</small>
                  </div>
            
                  <!-- Late fee input -->
                  <div class="mb-3" id="late_fee">
                    <label for="late_fee" class="form-label fw-bold arima-text text-secondary">Late Share Adjustment Fee</label>
                    <div class="input-group">
                      <input type="number" class="form-control border-0 shadow-sm" id="late_fee" name="late_fee" placeholder="Enter 0 if there is no fee" required>
                    </div>
                    <small class="fee-error-message text-danger"></small>
                  </div>
            
                  <!-- Notify members options -->
                  <div class="mb-3">
                    <small class="text-muted d-block mb-2" id="notifyMembers">Notify members that they can now increase their shares.</small>
                    <div class="d-flex align-items-center">
                      <div class="form-check form-switch me-3">
                        <input type="checkbox" class="form-check-input" id="notify" name="notify" onclick="toggleCheckBox('notify', 'dont_notify')">
                        <label class="form-check-label text-dark" for="notify">Notify Members</label>
                      </div>
                      <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="dont_notify" name="dont_notify" onclick="toggleCheckBox('dont_notify', 'notify')">
                        <label class="form-check-label text-dark" for="dont_notify">Don't Notify Members</label>
                      </div>
                    </div>
                    <small class="error-message text-danger" id="notifyError" style="display: none;">Please select whether to notify members or not.</small>
                  </div>
            
                  <!-- Buttons -->
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-danger btn-sm me-2 close-btn">Close</button>
                    <button type="submit" class="btn btn-success btn-sm">Activate Share Increase</button>
                  </div>
                </form>
                <script>
                  function toggleCheckBox(selectedid, unselectedid) {
                    const selectedCheckbox = document.getElementById(selectedid);
                    const unselectedCheckbox = document.getElementById(unselectedid);
            
                    if (selectedCheckbox.checked) {
                      unselectedCheckbox.checked = false;
                    }
            
                    // check if neither of the checkboxes is checked, show error message
                    const notifyError = document.getElementById('notifyError');
                    if (!selectedCheckbox.checked && !unselectedCheckbox.checked) {
                      notifyError.style.display = 'block';
                    } else {
                      notifyError.style.display = 'none';
                    }
                  }
                </script>
              </div>
            </div> <!-- End increase shares form -->
            

            <!-- allowNewMembers form -->
            <!-- increase shares form -->
            <div class="card shadow-lg border-0" id="allowNewMembersForm" style="display: none; background-color: #f9fafc;">
              <div class="card-body p-4">
                <div class="card-title text-success">
                  <h5 class="teko-text">Allow Late Members to Join the Activity</h5>
                  <hr>
                </div>
                <div class="pagetitle d-flex justify-content-between align-items-center mb-4">
                  <p class="arima-text text-secondary">
                    You can set the maximum number of shares that members can have, the deadline for joining the activity and a fee for late share adjustments if any.
                    New members will need to cover any past contributions for the new shares before the adjustment is made.
                  </p>
                </div>
            
                <form class="p-3" action="{% url 'manager:allow_new_activity_members' activity_id %}" method="POST">
                  {% csrf_token %}
                  <!-- Maximum shares input -->
                  <div class="mb-3">
                    <label for="max_shares" class="form-label fw-bold arima-text text-secondary">Maximum Number of Shares New Members Can Have</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light text-secondary fw-bold">Shares:</span>
                      <input type="number" class="form-control border-0 shadow-sm" id="max_shares" name="max_shares" min="1" required>
                      <small class="amount-error-message text-danger"></small>
                    </div>
                  </div>
            
                  <!-- Deadline input -->
                  <div class="mb-3" id="deadline">
                    <label for="deadline" class="form-label fw-bold arima-text text-secondary">Final Date to Join</label>
                    <div class="input-group">
                      <input type="date" class="form-control border-0 shadow-sm" id="deadline" name="deadline" required>
                    </div>
                    <small class="notify-manager text-danger">This date must be earlier than the next rotation date.</small>
                  </div>
            
                  <!-- Late fee input -->
                  <div class="mb-3" id="late_fee">
                    <label for="late_fee" class="form-label fw-bold arima-text text-secondary">Late Adjustment Fee</label>
                    <div class="input-group">
                      <input type="number" class="form-control border-0 shadow-sm" id="late_fee" name="late_fee" placeholder="Enter 0 if there is no fee" required>
                    </div>
                    <small class="fee-error-message text-danger"></small>
                  </div>
            
                  <!-- Buttons -->
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-danger btn-sm me-2 close-btn">Close</button>
                    <button type="submit" class="btn btn-success btn-sm">Allow New Members</button>
                  </div>
                </form>
                <script>
                  function toggleCheckBox(selectedid, unselectedid) {
                    const selectedCheckbox = document.getElementById(selectedid);
                    const unselectedCheckbox = document.getElementById(unselectedid);
            
                    if (selectedCheckbox.checked) {
                      unselectedCheckbox.checked = false;
                    }
            
                    // check if neither of the checkboxes is checked, show error message
                    const notifyError = document.getElementById('notifyError');
                    if (!selectedCheckbox.checked && !unselectedCheckbox.checked) {
                      notifyError.style.display = 'block';
                    } else {
                      notifyError.style.display = 'none';
                    }
                  }
                </script>
              </div>
            </div> <!-- End increase shares form -->

            <!-- admin fees form -->
            <div class="card shadow-lg border-0" id="adminFeesForm" style="display: none; background-color: #f9fafc;">
              <div class="card-body p-4">
                <div class="card-title text-success">
                  <h5 class="teko-text">Set Admin Fees</h5>
                  <hr>
                </div>
                <div class="pagetitle d-flex justify-content-between align-items-center mb-4">
                  <p class="arima-text text-secondary">
                    Set the admin fees for this activity. Admin fees can only be set before the first contribution day but can be adjusted after the last contribution day.
                    Admin fees will be added to the total amount contributed by members and will be deducted before any funds are disbursed.              
                  </p>
                </div>
            
                <form class="p-3" action="{% url 'manager:admin_fees' activity_id %}" method="POST">
                  {% csrf_token %}

                  <div class="mb-3">
                    <label for="admin_fee" class="form-label fw-bold arima-text text-secondary">New Admin Fee</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light text-secondary fw-bold">Ksh:</span>
                      <input type="number" class="form-control border-0 shadow-sm" id="admin_fee" name="admin_fee" required>
                      <small class="amount-error-message text-danger"></small>
                    </div>
                  </div>
                  <!-- Buttons -->
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-sm btn-outline-danger btn-sm me-2 close-btn">Close</button>
                    <button type="submit" class="btn btn-sm btn-outline-primary">Set Admin Fees</button>
                  </div>
                </form>
              </div>
            </div>
            <!-- end admin fees form -->

            <!-- remove member as admin form -->
            <div class="card overflow-auto shadow-lg border-0" id="removeMemberForm" style="display: none; background-color: #f9fafc;">
              <div class="card-body p-4">
                <div class="card-title text-success">
                  <h5 class="teko-text">Remove a Member from the Activity</h5>
                  <hr>
                </div>
                <div class="pagetitle d-flex justify-content-between align-items-center mb-4">
                  <p class="arima-text text-secondary">
                    As admin, you can remove a member from the activity. This action is irreversible. The member will be removed from the activity in accrodance to the EXIT rules set.
                    Search the member by their first name and last name, if there is more than one result, carefully click the correct member to remove.
                  </p>
                </div>
            
                <form id="searchMemberForm" class="p-3">
                  {% csrf_token %}
                  <!-- First  name and last name-->
                  <div class="mb-3">
                    <label for="first_name" class="form-label fw-bold text-secondary arima-text">Member Names *</label>
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <input type="text" class="form-control border-0 shadow-sm" id="first_name" name="first_name" required placeholder="first name">
                      </div>
                      <div>
                        <input type="text" class="form-control border-0 shadow-sm" id="last_name" name="last_name" required placeholder="last name">
                      </div>
                    </div>
                  </div>
            
                  <!-- Buttons -->
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-danger btn-sm me-2 close-btn">Close</button>
                    <button type="submit" class="btn btn-success btn-sm">Search Member</button>
                  </div>
                </form>

                <!-- Results table -->
                <div id="searchResults" class="mt-4 card-body" style="display: none;">
                  <p class="arima-text" style="color: #dc3545;"><strong>Results</strong></p>
                  <table class="table table-success table-striped-columns">
                    <thead>
                      <tr>
                        <th scope="col">Profile Picture</th>
                        <th scope="col">Name</th>
                        <th scope="col">Email</th>
                        <th scope="col">Action</th>
                      </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                      <!-- Dynamic rows will be inserted here -->
                    </tbody>
                  </table>
                </div>

                <script>
                  document.addEventListener("DOMContentLoaded", function () {
                    const activity_id = "{{ activity_id }}";
                    // console.log(activity_id);
                    const searchForm = document.getElementById("searchMemberForm");
                    const resultsDiv = document.getElementById("searchResults");
                    const resultsTableBody = document.getElementById("resultsTableBody");

                    document.getElementById("searchMemberForm").addEventListener("submit", async function (event) {
                      event.preventDefault();

                      const firstName = document.getElementById("first_name").value;
                      const lastName = document.getElementById("last_name").value;
                      // console.log("--------------------------------")
                      // console.log(firstName, lastName); 

                      resultsTableBody.innerHTML = ""; // Clear previous results

                      try {
                        const response = await fetch(`/manager/search_for_members_by_names/${activity_id}`, {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                          },
                          body: JSON.stringify({ first_name: firstName, last_name: lastName }),
                        });

                        const data = await response.json();
                        if (data.success) {
                          resultsDiv.style.display = "block";
                          data.members.forEach(member => {
                            const row = `
                              <tr>
                                <td><img src="${member.profile_picture}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;"></td>
                                <td>${member.first_name} ${member.last_name}</td>
                                <td>${member.email}</td>
                                <td>
                                  <button class="btn btn-sm btn-danger remove-member" data-member-id="${member.id}">Remove</button>
                                </td>
                              </tr>
                            `;
                            resultsTableBody.insertAdjacentHTML("beforeend", row);
                          });
                        } else {
                          alert(data.message);
                        }
                      } catch (error) {
                        console.error("Error searching members:", error);
                      }
                    });

                    // Event delegation for removing members
                    document.getElementById("searchResults").addEventListener("click", async function (event) {
                      if (event.target.classList.contains("remove-member")) {
                        const memberId = event.target.dataset.memberId;
                        // console.log("memberId", memberId);

                        try {
                          const response = await fetch(`/manager/remove_member_from_activity/${activity_id}/${memberId}`, {
                            method: "PUT",
                            headers: {
                              "Content-Type": "application/json",
                              "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                            },
                          });

                          const data = await response.json();
                          if (data.success) {
                            event.target.closest("tr").remove(); // Remove row from the table
                            alert("Member removed successfully.");
                          } else {
                            alert(data.message);
                          }
                        } catch (error) {
                          console.error("Error removing member:", error);
                          alert("An unexpected error occurred. Please try again.");
                        }
                      }
                    });
                  });

                </script>
              </div>
            </div>
            <!-- end remove member as admin form -->

            <!-- swap order form -->
            <div class="card overflow-auto shadow-lg border-0" id="swapOrderForm" style="display: none; background-color: #f9fafc;">
              <div class="card-body p-4">
                <div class="card-title text-success">
                  <h5 class="teko-text">Swap Members Order in Rotation Cycle</h5>
                  <hr>
                </div>
                <div class="pagetitle d-flex justify-content-between align-items-center mb-4">
                  <p class="arima-text text-secondary">
                    As admin, you can swap the order of members in the activity. This action is irreversible.
                    Search for the members by their current order number and swap them accordingly. Only members who are yet to receive their lump sum can be swapped.
                  </p>
                </div>
            
                <form id="searchOrderForm" class="p-3">
                  {% csrf_token %}
                  <!-- First  name and last name-->
                  <div class="mb-3">
                    <label for="position_one" class="form-label fw-bold text-secondary arima-text">Order Numbers</label>
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <input type="number" class="form-control border-0 shadow-sm" id="position_one" name="position_one" required placeholder="first order number">
                      </div>
                      <div>
                        <input type="number" class="form-control border-0 shadow-sm" id="position_two" name="position_two" required placeholder="second order number">
                      </div>
                    </div>
                  </div>
            
                  <!-- Buttons -->
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-danger btn-sm me-2 close-btn">Close</button>
                    <button type="submit" class="btn btn-success btn-sm">Search Members</button>
                  </div>
                </form>

                <!-- Results table -->
                <div id="orderResults" class="mt-4 card-body" style="display: none;">
                  <p class="arima-text" style="color: #dc3545;"><strong>Results</strong></p>
                  <table class="table table-success table-striped-columns">
                    <thead>
                      <tr>
                        <th scope="col">Profile Picture</th>
                        <th scope="col">Name</th>
                        <th scope="col">Share</th>
                        <th scope="col">Current Order Number</th>
                      </tr>
                    </thead>
                    <tbody id="orderResultsTableBody">
                      <!-- Dynamic rows will be inserted here -->
                    </tbody>
                  </table>
                  <div class="d-flex justify-content-end">
                    <button type="submit" id="swapButton" class="btn btn-success btn-sm" style="display: none;" >Swap Members</button>
                </div>

                <script>
                  document.getElementById("searchOrderForm").addEventListener("submit", function (e) {
                    e.preventDefault();

                    const positionOne = document.getElementById("position_one").value;
                    const positionTwo = document.getElementById("position_two").value;
                    const activityId = "{{ activity_id }}"; // Replace with your dynamic activity ID
                    // console.log("======search by order=========")

                    fetch(`/manager/search_for_members_by_order_number/${activityId}`, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                      },
                      body: JSON.stringify({ position_one: positionOne, position_two: positionTwo }),
                    })
                      .then((response) => response.json())
                      .then((data) => {
                        if (data.members) {
                          const tableBody = document.getElementById("orderResultsTableBody");
                          tableBody.innerHTML = ""; // Clear existing rows

                          data.members.forEach((member) => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                              <td>
                                <img src="${member.profile_picture}" alt="Profile" class="rounded-circle" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                              </td>
                              <td>${member.full_name}</td>
                              <td>${member.share_name}</td>
                              <td>${member.order_number}</td>
                            `;
                            tableBody.appendChild(row);
                          });

                          document.getElementById("orderResults").style.display = "block";
                          document.getElementById("swapButton").style.display = "block";

                          // Attach click event to the Swap button
                          document.getElementById("swapButton").onclick = function () {
                            swapMembers(positionOne, positionTwo, activityId);
                          };
                        } else {
                          alert(data.error || "No members found.");
                        }
                      })
                      .catch((error) => {
                        console.error("Error:", error);
                        alert("Members not found, confirm the order numbers and try again")
                      });
                  });

                  function swapMembers(positionOne, positionTwo, activityId) {
                    // console.log("======swapping members========")
                    // console.log("positionOne", positionOne)
                    // console.log("positionTwo", positionTwo)
                    fetch(`/manager/swap_members_order_in_rotation/${activityId}/${positionTwo}/${positionOne}`, {
                      method: "PUT",
                      headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                      },
                    })
                      .then((response) => response.json())
                      .then((data) => {
                        if (data.message) {
                          alert("Members swapped successfully.");
                          location.reload(); // Reload the page to reflect changes
                        } else {
                          alert(data.error || "Failed to swap members.");
                        }
                      })
                      .catch((error) => {
                        console.error("Error:", error);
                        alert("Failed to swap members. Please try again.");
                      });
                  }

                </script>

              </div>
              </div>

            <!-- end of swap order form -->

          </div>
        </div><!-- End Left side columns -->
        
      </div>

    </section>

  </main><!-- End #main -->

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const cards = document.querySelectorAll('.clickable-card');
    const forms = document.querySelectorAll('.card-body + .card');


    // retrieve all card ids
    const increaseSharesCard = document.getElementById('increaseSharesCard');
    const increaseSharesForm = document.getElementById('increaseSharesForm');

    const allowNewMembersCard = document.getElementById('allowNewMembersCard');
    const allowNewMembersForm = document.getElementById('allowNewMembersForm');

    const swapOrder = document.getElementById('swapOrder');
    const swapOrderForm = document.getElementById('swapOrderForm');

    const reduceSharesCard = document.getElementById('reduceSharesCard');
    const reduceSharesForm = document.getElementById('reduceSharesForm');

    const removeMemberCard = document.getElementById('removeMemberCard');
    const removeMemberForm = document.getElementById('removeMemberForm');

    const adminFeesCard = document.getElementById('adminFeesCard');
    const adminFeesForm = document.getElementById('adminFeesForm');

    // show the form when the card is clicked and hide all other cards
    increaseSharesCard.addEventListener('click', function() {
      increaseSharesForm.style.display = 'block';
      cards.forEach(c => {
        if (c !== increaseSharesForm) {
          c.style.display = 'none';
        }
      });
    });

    allowNewMembersCard.addEventListener('click', function() {
      allowNewMembersForm.style.display = 'block';
      allowNewMembersCard.style.display = 'block';
      cards.forEach(c => {
        if (c !== allowNewMembersForm) {
          c.style.display = 'none';
        }
      });
    });

    swapOrder.addEventListener('click', function() {
      swapOrderForm.style.display = 'block';
      cards.forEach(c => {
        if (c !== swapOrderForm) {
          c.style.display = 'none';
        }
      });
    });


    reduceSharesCard.addEventListener('click', function() {
      reduceSharesForm.style.display = 'block';
      cards.forEach(c => {
        if (c !== reduceSharesForm) {
          c.style.display = 'none';
        }
      });
    });

    removeMemberCard.addEventListener('click', function() {
      removeMemberForm.style.display = 'block';
      cards.forEach(c => {
        if (c !== removeMemberForm) {
          c.style.display = 'none';
        }
      });
    });

    adminFeesCard.addEventListener('click', function() {
      adminFeesForm.style.display = 'block';
      cards.forEach(c => {
        if (c !== adminFeesForm) {
          c.style.display = 'none';
        }
      });
    });
   
    
    // Close button functionality
    const closeButtons = document.querySelectorAll('.close-btn');
    closeButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Hide the form
        this.closest('.card').style.display = 'none';
        
        // Show all cards again
        cards.forEach(c => c.style.display = 'block');
      });
    });



    // SEARCH AND RESULTS FUNCTIONALITY
    
    
  });
</script>

<style>

.rounded-circle {
  border-radius: 50%;
  border: 2px solid #28a745; /* Optional: Add a border */
}

  /* Beautiful styling for the paragraph */
  .beautiful-paragraph {
    font-family: 'Arial', sans-serif;
    font-size: 1.1em;
    line-height: 1.5;
    color: #5a5a5a;
    border-left: 4px solid #28a745;
    padding-left: 12px;
    margin-bottom: 15px;
  }

  /* Beautiful styling for the paragraph */
.arima-text {
  font-family: "Arima", system-ui;
  font-optical-sizing: auto;
  font-weight: 600;
  font-style: normal;
}

.teko-text {
font-family: "Teko", sans-serif;
font-optical-sizing: auto;
font-weight: 600;
font-style: normal;
}

.clickable-card {
cursor: pointer;
transition: transform 0.2s;
}

.clickable-card:hover {
transform: scale(1.05);
}

.custom-input-group {
  background-color: #f8f9fa; /* Light background color */
  border-radius: 5px; /* Rounded corners */
  padding: 10px; /* Padding around the group */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
}

.custom-input-group .input-group-text {
    background-color: #e9ecef; /* Slightly darker background for the label */
    border: none; /* Remove border */
    border-radius: 5px 0 0 5px; /* Rounded corners for the left side */
}

.custom-input {
    border-radius: 0 5px 5px 0; /* Rounded corners for the right side */
    background-color: #ffffff; /* White background for the input */
}
</style>
  

 {% endblock %}